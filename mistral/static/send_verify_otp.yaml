---
version: '2.0'
send_verify_otp:
  description: Send the OTP & verify it.
  type: direct
  input:
    - api_server: http://172.18.0.1:8000
    - process_generate_otp: 98dd9de9-3e47-4178-8ab1-8ea911a8b203
    - process_send_sms: a620893f-1b8c-49cd-b306-42c2708b4d5c
    - process_wait_for_input: 6a52d439-3053-46ca-bd3a-a825891ca501
    - process_verify_otp: 67b1f054-aa96-4d5e-8e90-c55245322c65
    - process_publish_result: 29c392aa-4181-4ad3-acbf-860c84405795
    - phone_number
    - session
    - widget
    - headers
  tasks:
    generate_otp:
      action: std.http
      input:
        url: <% $.api_server %>/api/v1/widgets/<% $.widget %>/<% $.process_generate_otp %>/
        method: POST
        body: '{ "time": 300 }'
        headers: <% $.headers %>
      on-success:
        - send_sms
    send_sms:
      action: std.http
      input:
        url: <% $.api_server %>/api/v1/widgets/<% $.widget %>/<% $.process_send_sms %>/
        method: POST
        body: '{ "to": "<% $.phone_number %>", "body": "OTP: <% task(generate_otp).result.content.otp %>", "provider": "plivo" }'
        headers: <% $.headers %>
      publish:
        key: <% $.widget %>
        value: '{ "template": "step_2", "__message": "OTP Sent. Valid for 5 mins.", "__phone": "<% $.phone_number %>" }'
      on-success:
        - publish_result
        - wait_for_input
    wait_for_input:
      workflow: wait_for_key
      input:
        url: <% $.api_server %>/api/v1/widgets/<% $.widget %>/<% $.process_wait_for_input %>/
        method: POST
        body: '{ "key": "input__otp", "uuid": "<% $.session %>" }'
        headers: <% $.headers %>
        key: "otp"
      retry: delay=10 count=30
      publish:
        key: <% $.widget %>
        value: '{ "message": "OTP Sent. Valid for 5 mins.", "phone": "<% $.phone_number %>" }'
      publish-on-error:
        key: <% $.widget %>
        value: '{ "errors": [ "OTP expired. Request Again" ] }'
      on-success:
        - verify_otp
        - publish_result
      on-error:
        - publish_result
    verify_otp:
      action: std.http
      input:
        url: <% $.api_server %>/api/v1/widgets/<% $.widget %>/<% $.process_verify_otp %>/
        method: POST
        body: '{ "uuid": "<% task(generate_otp).result.content.otp_uuid %>", "otp": "OTP: <% task(wait_for_input).result.content.otp %>", "otp_type": "totp" }'
        headers: <% $.headers %>
      retry: delay=10 count=30
      publish:
        key: <% $.widget %>
        value: '{ "template": "resolved", "message": "OTP Verified" }'
      publish-on-error:
        key: <% $.widget %>
        value: '{ "errors": "Invalid OTP" }'
      on-complete:
        - publish_result
    publish_result:
      action: std.http
      input:
        url: <% $.api_server %>/api/v1/widgets/<% $.widget %>/<% $.process_publish_result %>/
        method: POST
        headers: {
          Content-Type: 'application/json'
        }
        body: '{ "data": <% $.value %>, "key": "<% $.key %>", "uuid": "<% $.session %>" }'
