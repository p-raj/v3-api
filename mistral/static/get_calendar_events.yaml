---
version: '2.0'
get_calendar_events:
  description: Fetch the calendar events & check whether the room is available
  type: direct
  input:
  - api_server: http://apis.noapp.mobi
  - process__fetch_calendar_events: 91269c55-ee85-4720-87a9-aa2efc4222c9
  - process__publish_result: 29c392aa-4181-4ad3-acbf-860c84405795
  - headers:
      Content-type: application/json
  - session
  - widget
  - calendar_event_api_data
  - widget_room_info: a705fec4-112f-4905-a26b-33fb64d39c2c
  tasks:
    publish_initial_data:
      action: std.noop
      publish:
        token_endpoint: "<% $.calendar_event_api_data.token_endpoint %>"
        client_id: "<% $.calendar_event_api_data.client_id %>"
        client_secret: "<% $.calendar_event_api_data.client_secret %>"
        refresh_token: "<% $.calendar_event_api_data.refresh_token %>"
        access_token: "<% $.calendar_event_api_data.access_token %>"
        token_type: Bearer
      on-success:
      - fetch_calendar_events
    fetch_calendar_events:
      action: std.http
      input:
        url: "<% $.api_server %>/api/v1/widgets/<% $.widget %>/<% $.process__fetch_calendar_events %>/"
        method: POST
        body:
          timeMin: "<% let(now() - timespan(hours => 1)) -> $.format('%Y-%m-%dT%H:%M:%S%z') %>"
          showDeleted: false
          maxResults: 5
          Authorization: "<% $.token_type %> <% $.access_token %>"
        headers: "<% $.headers %>"
      publish:
        data: "<% task(fetch_calendar_events).result.content %>"
        items: "<% task(fetch_calendar_events).result.content.items %>"
#      publish-on-error:
#        key: "<% $.widget %>"
#        value:
#          template: init
#        items: []
      on-success:
      - available: "<% task(fetch_calendar_events).result.content.items.takeWhile(datetime($.start.dateTime) < now() and now() < datetime($.end.dateTime)).count() = 0 %>"
      - unavailable: "<% task(fetch_calendar_events).result.content.items.takeWhile(datetime($.start.dateTime) < now() and now() < datetime($.end.dateTime)).count() > 0 %>"
      on-error:
#      - publish_result
      - refresh_token: "<% task(fetch_calendar_events).result.status = 401 %>"
    available:
      action: std.noop
      publish:
        template: available
      on-complete:
      - publish_events
    unavailable:
      action: std.noop
      publish:
        template: busy
      on-complete:
      - publish_events
    publish_events:
      action: std.noop
      publish:
        key: "<% $.widget %>"
        value:
          template: <% $.template %>
          input.calendar_event_api_data.access_token: "<% $.access_token %>"
          __date__: "<% now() %>"
          __events__: "<% $.items.select($.set('attendeesCount', $.attendees.where($.get('resource', false) = false).count())) %>"
          __info__: "<% switch($.items.count() > 0 => $.items.count(), $.items.count() = 0 => 'No') %> meetings scheduled for today."
      on-complete:
      - publish_result
    refresh_token:
      workflow: refresh_oauth_token
      input:
        token_endpoint: "<% $.token_endpoint %>"
        client_id: "<% $.client_id %>"
        client_secret: "<% $.client_secret %>"
        refresh_token: "<% $.refresh_token %>"
      publish:
        access_token: "<% task(refresh_token).result.access_token %>"
        token_type: "<% task(refresh_token).result.token_type %>"
      on-success:
      - fetch_calendar_events
    publish_result:
      workflow: publish_feedback_to_interface widget=<% $.widget %> session=<% $.session %> key=<% $.key %> value=<% $.value %> api_server=<% $.api_server %> process__publish_result=<% $.process__publish_result %>
